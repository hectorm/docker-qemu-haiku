#!/bin/sh

set -eu

set --
set -- "$@" -smp "${VM_CPU:?}" -m "${VM_RAM:?}"
set -- "$@" -serial stdio -monitor unix:/run/qemu-monitor,server,nowait -device VGA -display vnc=:0
set -- "$@" -drive file=/var/lib/qemu/haiku.qcow2,index=0,media=disk,format=qcow2
set -- "$@" -netdev user,id=n0,guestfwd=tcp:10.0.2.254:1337-cmd:'nc 127.0.0.1 1337',hostfwd=tcp::2222-:22,"${VM_NET_OPTIONS?}"
set -- "$@" -device e1000,netdev=n0
set -- "$@" -usb -device usb-tablet
set -- "$@" -k "${VM_KEYBOARD:?}"

if [ "${VM_KVM:?}" = true ] && [ -c /dev/kvm ]; then
	set -- "$@" -accel kvm
else
	set -- "$@" -accel tcg,thread=single
fi

cd /var/lib/qemu/
exec 2>&1
exec /usr/bin/qemu-system-x86_64 "$@"
